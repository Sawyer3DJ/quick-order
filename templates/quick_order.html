<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick Order â€” Table {{ table_num }}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #FF6A13, #1a1a1a) fixed no-repeat;
      background-size: cover;
      color: white; margin:0; padding:0;
    }
    .container {
      max-width: 600px; margin: 30px auto;
      padding: 20px; background: #222;
      border-radius: 10px; display: none;
    }
    .container.active { display: block; }
    h1, h2 { color: #FF6A13; margin-bottom:10px; }
    .menu-list { list-style:none; margin:0; padding:0; }
    .menu-item {
      display:flex; align-items:center;
      border-bottom:1px solid #444; padding:10px 0;
    }
    .menu-item:last-child { border-bottom:none; }
    .item-label { flex:2; }
    .item-size {
      flex:1; margin:0 10px;
      padding:6px; font-size:1.1em;
      border-radius:4px; border:none;
      background:#333; color:#fff;
    }
    .item-price { flex:1; text-align:right; font-family:Arial; }
    .add-btn {
      width:36px; height:36px;
      background:#28a745; color:#fff;
      border:none; border-radius:50%;
      font-size:1.2em; line-height:36px;
      text-align:center; cursor:pointer;
      margin-left:10px;
    }
    #orderList { margin-top:20px; }
    .order-item {
      display:flex; justify-content:space-between;
      align-items:center; margin:5px 0;
    }
    .order-item span { font-size:1.05em; font-family:Arial; }
    .remove-btn {
      background:#dc3545; color:white;
      border:none; border-radius:5px;
      padding:5px 10px; cursor:pointer;
    }
    #total {
      text-align:right; font-weight:bold;
      margin-top:10px; font-size:1.2em;
      font-family:Arial;
    }
    textarea {
      width:100%; height:60px; margin-top:10px;
      font-size:1em; padding:8px;
      border-radius:5px; border:1px solid #444;
      background:#333; color:#fff;
      font-family:Arial;
    }
    .btn {
      display:inline-block; padding:14px 20px;
      margin-top:15px; font-size:1.2em;
      border:none; border-radius:5px;
      cursor:pointer; font-family:Arial;
      text-align:center;
    }
    .btn.grey     { background:#888; color:#fff; }
    .btn.green    { background:#28a745; color:#fff; }
    .btn.green[disabled] { background:grey; cursor:not-allowed; }
    .divider { margin:30px 0 10px; border-top:1px solid #444; }
    #reviewSummary { font-family:Arial; line-height:1.5em; }
    /* Success screen styling */
    #successPage h1 { font-size:1.8em; text-align:center; }
    #orderTicket {
      text-align:center; font-size:2.2em;
      margin:15px 0; font-weight:bold;
    }
  </style>
</head>
<body>

  <!-- Welcome -->
  <div class="container active" id="welcomePage">
    <h1>Welcome â€” Table {{ table_num }}</h1>
    <button class="btn green" onclick="startOrder()">Start Quick Order</button>
  </div>

  <!-- Menu -->
  <div class="container" id="menuPage">
    <h1>Quick Order Menu</h1>

    <!-- Food Section -->
    <h2>Food</h2>
    <ul class="menu-list">
      {% for d in dishes if d.category=='Food' %}
      <li class="menu-item">
        <span class="item-label">{{ d.name }}</span>
        <select id="size-{{ d.id }}" class="item-size"
                onchange="updatePrice({{ d.id }})">
          {% for sz, price in d.sizes.items() %}
            <option value="{{ sz }}">{{ sz }}</option>
          {% endfor %}
        </select>
        <span id="price-{{ d.id }}" class="item-price">
          Â£{{ "%.2f"|format(d.sizes.values()|list|first) }}
        </span>
        <button class="add-btn" onclick="addItem({{ d.id }})">+</button>
      </li>
      {% endfor %}
    </ul>

    <!-- Drinks Section -->
    <h2>Drinks</h2>
    <ul class="menu-list">
      {% for d in dishes if d.category=='Drink' %}
      <li class="menu-item">
        <span class="item-label">{{ d.name }}</span>
        <select id="size-{{ d.id }}" class="item-size"
                onchange="updatePrice({{ d.id }})">
          {% for sz, price in d.sizes.items() %}
            <option value="{{ sz }}">{{ sz }}</option>
          {% endfor %}
        </select>
        <span id="price-{{ d.id }}" class="item-price">
          Â£{{ "%.2f"|format(d.sizes.values()|list|first) }}
        </span>
        <button class="add-btn" onclick="addItem({{ d.id }})">+</button>
      </li>
      {% endfor %}
    </ul>

    <div class="order-list" id="orderList"></div>
    <div id="total">Total: Â£0.00</div>

    <textarea id="comments" placeholder="Comments or allergies?"></textarea>
    <button id="reviewBtn" class="btn green" onclick="reviewOrder()" disabled>
      Review Order
    </button>
  </div>

  <!-- Review -->
  <div class="container" id="reviewPage">
    <h1>Your Order</h1>
    <div id="reviewSummary"></div>
    <div class="divider"></div>
    <button class="btn grey goBack" onclick="goBack()">Go Back</button>
    <button class="btn green" onclick="placeOrder()">Place Order</button>
  </div>

  <!-- Success -->
  <div class="container" id="successPage">
    <h1>Order Placed!</h1>
    <div id="orderTicket">
      Table {{ table_num }} â€” #<span id="orderNumber">0000</span>
    </div>
    <p>Please have payment ready.</p>
    <button class="btn green" onclick="startOrder()">New Quick Order</button>
  </div>

  <script>
    const tableNum = {{ table_num }},
          endpoint = "{{ url_for('receive_order') }}",
          testurl  = "{{ url_for('test') }}",
          menuData = {
            {% for d in dishes %}
            {{ d.id }}: {
              name: "{{ d.name }}",
              sizes: {{ d.sizes|tojson }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          };

    let order = [];

    function startOrder(){
      order = []; renderOrder();
      document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
      document.getElementById('menuPage').classList.add('active');
      // initialize all prices
      Object.keys(menuData).forEach(id=>updatePrice(id));
    }

    function updatePrice(id){
      const sel   = document.getElementById(`size-${id}`),
            size  = sel.value,
            price = menuData[id].sizes[size]||0;
      document.getElementById(`price-${id}`)
              .innerText = `Â£${price.toFixed(2)}`;
    }

    function addItem(id){
      const sel   = document.getElementById(`size-${id}`),
            size  = sel.value,
            name  = menuData[id].name + " " + size,
            price = menuData[id].sizes[size]||0;
      const ex = order.find(i=>i.name===name);
      if(ex) ex.quantity++; else order.push({name,quantity:1,price});
      renderOrder();
    }

    function removeItem(i){
      if(--order[i].quantity===0) order.splice(i,1);
      renderOrder();
    }

    function renderOrder(){
      const list = document.getElementById('orderList'),
            btn  = document.getElementById('reviewBtn');
      list.innerHTML=''; let total=0;
      order.forEach((it,i)=>{
        const cost = it.price * it.quantity;
        total += cost;
        list.innerHTML +=
          `<div class="order-item">
             <span>${it.quantity}Ã— ${it.name} (Â£${cost.toFixed(2)})</span>
             <button class="remove-btn" onclick="removeItem(${i})">ðŸ—‘</button>
           </div>`;
      });
      document.getElementById('total').innerText = `Total: Â£${total.toFixed(2)}`;
      btn.disabled = order.length===0;
    }

    function reviewOrder(){
      let txt = order.map(i=>
        `${i.quantity}Ã— ${i.name} â€” Â£${(i.price*i.quantity).toFixed(2)}`
      ).join("\n");
      const comments = document.getElementById('comments').value,
            total    = order.reduce((s,i)=>s+i.price*i.quantity,0).toFixed(2);
      document.getElementById('reviewSummary').innerText =
        txt + `\n\nComments: ${comments}\n\nTotal: Â£${total}`;
      document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
      document.getElementById('reviewPage').classList.add('active');
    }

    function goBack(){
      document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
      document.getElementById('menuPage').classList.add('active');
    }

    function placeOrder(){
      const comments = document.getElementById('comments').value,
            orderNum  = Math.floor(1000+Math.random()*9000);
      fetch(endpoint, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ table:tableNum, order, comments, orderNum })
      })
      .then(r=>{ if(!r.ok) throw ''; return r.json() })
      .then(_=>{
        document.getElementById('orderNumber').innerText = orderNum;
        document.querySelectorAll('.container').forEach(c=>c.classList.remove('active'));
        document.getElementById('successPage').classList.add('active');
      })
      .catch(_=>alert('Order failed'));
    }

    function pingServer(){
      fetch(testurl).then(r=>r.text()).then(m=>
        document.getElementById('pingResult').innerText = 'âœ“ '+m
      ).catch(_=>
        document.getElementById('pingResult').innerText = 'âœ— Cannot reach server'
      );
    }
  </script>
</body>
</html>
